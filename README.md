# Распознавание корректно заполненных согласий на обработку персональных данных 

Проект разработан для kruzhok.pro в 2020 г.

[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)

## Описание проекта
Данная утилита определяет является ли присланная пользователем форма согласия на обработку персональных данных корректно заполненной. Код не зависит от выбранной формы и нет необходимости его переписывать при работе с формой нового типа - возможна конфигурация "под текущую форму".

### Этапы
1. Попытка развернуть присланную форму так, чтобы она совпадала с шаблонной формой.
2. Определение того, на сколько совпадают присланная пользователем форма и исходная. Если коэффицент совпадения слишком низок, осуществляется выход из программы.
3. Анализ каждого поля в присланной форме на предмет того, является ли оно заполненным. Если процент заполненных полей от общего числа превышает определенный порог, выводит "ok".

### Дополнительная фича
Как продемонстрировано на фотографии ниже, код может также генерировать специальный файл с выровненной формой, в которой будут зеленым обведены заполненные поля, а красным - незаполненные. Над ними будут значения MSE - если они больше определенного значения (по дефолту 4000), то поле считается заполненным. Этот файл можно использовать, чтобы показать пользователю если система посчитает, что его форма незаполнена. Она покажет на незаполненные поля. Также в перспективе может реализовывать более сложные сценарий взаимодействия - например указывать на то, что одновременно заполнены оба поля с данными об удостоверении личности, хотя нужно заполнить только одно (пример из третьей формы).

![](https://github.com/VladKovalevv/ReadmeNTI/blob/main/return.jpg)

### Основные технические концепции	
- ORB keypoint detector для выделения фич.
- BFMatcher для сопоставления выделенных фич.
- findHomography для разворота изображения по полученным на предыдущих этапах точкам.
- matchTemplate для проверки того, является ли развернутое изображение исходной формой (не прислал ли пользователь что-то левое).
- MSE (mean squared error) для сопоставления полей на присланной форме и исходной. Помогает отделить заполненную форму от незаполненной.

## Запуск скрипта

### Важная информация
- Текущий скрипт может без настройки работать с формами типа 1, 2, 3. Все данные, связанные с ниим, находятся в папке ```data```. Для нового типа форм нужно добавить файлы с формой и полями в папку ```data```. 
  - sogl{номер формы}_image.jpg - сам файл согласия.
  - sogl{номер формы}_orb.pickle - предпросчитанные orb keypoints для последующего использования. Позволяет ускорить время работы скрипта. При необходимости можно рассчитывать их "на ходу".
  - sogl{номер формы}_fields.json - файл с полями для анализа форма [["Название поля", (y2, y1), (x2, x1)], ...]
- Скрипт работает хорошо на формах в качестве не ниже среднего (где можно различить текст). На остальных формах процент ложно отрицательных результатов увеличивается.
- Во избежание большого количества ложно отрицательных результатов порог заполненных полей выбирается равным 80 процентам. Это позволяет не бояться погрешностей в развороте формы и делает скрипт универсальным (работающим на практически любых формах без изменений).
- Скрипт хорошо работает как на отсканированных формах, так и на формах, сфотографированных с телефона (с разного угла, в разном качестве).

### Установка
- Удостовериться что версия python > 3.5
- ```git clone https://github.com/azarenkovgd/consents-recognition```
- ```cd consents-recognition```
- При необходимости установить venv (virtual enviroment) через ```apt-get install python3-venv```
- Создание venv ```python3 -m venv . ```
- Активация ```source bin/activate```
- Установка требуемых библиотек ```pip install -r requirements.txt```

### Запуск 
- Cкрипт запуска программы - ```main.py```
- Аргументы:
  - ```-f``` если флаг активен, то скрипт будет запущен на всех файлах по указанному пути (path). Если нет, то воспринимает путь (path) как местоположение файла и запустит скрипт на нем.
  - ```path``` путь к файлу согласия (отправленного пользователем) или к папке с файлами согласий.
  - ```number``` номер исходного (незаполненного) согласия (1/2/3).
  - ```-p --parameters``` путь к файлу с параметрами. По умолчанию ```parameters.json```.

### Структура проекта
- ```data``` папка с данными об исходных (незаполненных) согласиях.
- ```fields``` папка с экспериментальной фичей, которая позволяет загружать данные о полях их специально отредактированного файла. 
- ```alignment.py``` файл, содержаший код, выравнивающий отправленную пользователем форму для дальнейшей обработки.
- ```loadsave.py``` вспомогательный файл, содержаший функции для загрузки и сохранения данных.
- ```recognition.py``` файл, содержащий код, который оценивает то, на сколько хорошо была выравнена форма и процент заполненных в ней полей.
- ```main.py``` точка входа, файл, через который происходит тестирование программы.
- ```return.jpg``` файл иллюстраци для README.md.

### Команда
Азаренков Георгий https://github.com/azarenkovgd

Владислав Ковалев https://github.com/VladKovalevv
